<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>ä¼˜åŒ–è‡ªåŠ¨å¼å“åº”</title>
</head>
<body>
<script>
  const targetMap = new WeakMap()
  let activeEffect = null // ğŸ‘ˆ æ–°å¢ï¼Œæ˜¯å¦éœ€è¦æ·»åŠ effectçš„æ ‡å¿—

  function track(target, key) {
    // ğŸ‘‡ æ–°å¢ï¼Œåªæœ‰å†activeEffectä¸ºçœŸæ—¶æ‰æ‰§è¡Œä¿å­˜çš„æ“ä½œ
    if (activeEffect) {
      let depsMap = targetMap.get(target)
      if (!depsMap) {
        targetMap.set(target, (depsMap = new Map()))
      }
      let dep = depsMap.get(key)
      if (!dep) {
        depsMap.set(key, (dep = new Set()))
      }
      dep.add(activeEffect) // ğŸ‘ˆ ä¿®æ”¹ï¼Œå°†ç›´æ¥æ·»åŠ effectæ”¹ä¸ºäº†æ·»åŠ activeEffect
    }
  }

  function trigger(target, key) {
    const depsMap = targetMap.get(target)
    if (depsMap) {
      let dep = depsMap.get(key)
      if (dep) {
        dep.forEach(effect => effect())
      }
    }
  }

  function reactive(target) {
    return new Proxy(target, {
      get(target, key, receiver) {
        let result = Reflect.get(target, key, receiver)
        console.log('è°ƒç”¨track()')
        track(target, key)
        return result
      },
      set(target, key, value, receiver) {
        let oldValue = target[key]
        let result = Reflect.set(target, key, value, receiver)
        if (result && oldValue !== value) {
          trigger(target, key)
        }
        return result
      }
    })
  }

  // ğŸ‘‡ æ–°å¢
  // ä¸ºäº†ç”¨ç»Ÿä¸€çš„æ–¹å¼ï¼ŒæŠŠeffæ·»åŠ åˆ°å¯¹åº”çš„depä¸­ï¼Œé¡ºä¾¿è¿˜æ‰§è¡Œäº†ä¸€éè®¾ç½®äº†åˆå§‹å€¼
  // è¿™æ ·ä»¥åï¼Œåªæœ‰æˆ‘ä»¬æ‰‹åŠ¨è°ƒç”¨effecté‚£æ¬¡æ‰ä¼šä¿å­˜depï¼Œç”¨triggerè§¦å‘çš„getå°±ä¸ä¼šå†ä¿å­˜ä¸€éäº†
  function effect(eff) {
    activeEffect = eff
    activeEffect()
    activeEffect = null
  }

  let product = reactive({
    price: 5,
    quantity: 2
  })
  let salePrice = 0
  let total = 0

  // ğŸ‘‡ åŒç†ä¹Ÿè¦å¯¹effectå‡½æ•°æ”¹é€ ï¼ŒæŠŠæ¯ä¸€ä¸ªè¦ä¿å­˜çš„depå˜ä¸ºäº†effectå‡½æ•°çš„å‚æ•°
  // æ‰‹åŠ¨è®¾å®šäº†totalå‘ƒsalePriceçš„åˆå§‹å€¼
  effect(() => {
    total = product.price * product.quantity
  })
  // æ‰€ä»¥è¿™é‡Œå°±ä¸ä¼šæŠŠè¿™ä¸ªeffæ·»åŠ ç»™quantity
  effect(() => {
    salePrice = product.price * 0.9
  })

  console.log(total, salePrice) // output: 10, 4.5

  // è®¾ç½®quantityåªä¼šé‡æ–°è®¡ç®—total å› ä¸ºæ­¤æ—¶activeEffectæ˜¯null
  product.quantity = 3
  console.log(total, salePrice) // output: 15, 4.5

  // è®¾ç½®priceåï¼Œtotalå’ŒsalePriceå¯¹åº”çš„effectéƒ½ä¼šæ‰§è¡Œï¼Œéƒ½ä¼šè¢«é‡æ–°è®¡ç®—
  product.price = 10
  console.log(total, salePrice) // output: 30, 9

</script>
</body>
</html>